FROM node:18-alpine

# Создание рабочей директории
WORKDIR /app

# Копирование только package.json (без pnpm-lock)
COPY package.json ./

# Клонирование репозитория esbuild и установка его напрямую
RUN apk add --no-cache git && \
    npm install --no-save esbuild && \
    npm install

# Копирование исходного кода приложения
COPY . .

# Проверка версии esbuild
RUN node -e "console.log('esbuild version:', require('esbuild').version)"

# Создание директории для OpenAPI спецификации
RUN mkdir -p /app/openapi

# Копирование файла todoist.yaml в директорию внутри контейнера
COPY todoist.yaml /app/openapi/todoist.yaml

# Ручная установка требуемых платформенных зависимостей esbuild
RUN mkdir -p node_modules/esbuild/lib/linux && \
    echo "console.log('Linux platform stub')" > node_modules/esbuild/lib/linux/stub.js && \
    npm rebuild

# Модифицированный шаг сборки, который использует prebuilt версию esbuild если возможно
RUN npm run build || (echo "Falling back to TypeScript compilation only" && npx tsc -build)

# Открытие порта для MCP сервера
EXPOSE 3000

# Запуск сервера с вашей спецификацией Todoist API
CMD ["npm", "start"]
